<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  <title>Figma Translation Plugin</title>
  <style>
    * {
      box-sizing: border-box;
      margin: 0;
      padding: 0;
    }

    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', 'Roboto', 'Helvetica', 'Arial', sans-serif;
      background: #fafbfc;
      color: #1f2937;
      font-size: 13px;
      line-height: 1.5;
      overflow-x: hidden;
    }

    /* Header */
    .header {
      background: #034ea2;
      padding: 16px 20px;
      border-bottom: 1px solid rgba(0, 0, 0, 0.1);
    }

    .header-content {
      display: flex;
      align-items: center;
      justify-content: space-between;
    }

    .header-title {
      color: #ffffff;
      font-size: 14px;
      font-weight: 600;
      letter-spacing: -0.01em;
    }

    .header-subtitle {
      color: rgba(255, 255, 255, 0.7);
      font-size: 11px;
      margin-top: 2px;
    }

    /* Container */
    .container {
      padding: 20px;
      max-width: 100%;
    }

    /* Workflow Steps */
    .workflow {
      display: flex;
      align-items: center;
      justify-content: space-between;
      margin-bottom: 24px;
      padding: 16px;
      background: white;
      border: 1px solid #e5e7eb;
      border-radius: 6px;
    }

    .workflow-step {
      display: flex;
      flex-direction: column;
      align-items: center;
      flex: 1;
      position: relative;
    }

    .workflow-step:not(:last-child)::after {
      content: '';
      position: absolute;
      right: -50%;
      top: 16px;
      width: 100%;
      height: 2px;
      background: #e5e7eb;
      z-index: 0;
    }

    .workflow-step.active:not(:last-child)::after {
      background: #034ea2;
    }

    .step-circle {
      width: 32px;
      height: 32px;
      border-radius: 50%;
      background: #f3f4f6;
      border: 2px solid #e5e7eb;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 12px;
      font-weight: 600;
      color: #9ca3af;
      margin-bottom: 8px;
      position: relative;
      z-index: 1;
    }

    .workflow-step.active .step-circle {
      background: #034ea2;
      border-color: #034ea2;
      color: white;
    }

    .workflow-step.completed .step-circle {
      background: #10b981;
      border-color: #10b981;
      color: white;
    }

    .step-label {
      font-size: 11px;
      color: #6b7280;
      text-align: center;
      font-weight: 500;
    }

    .workflow-step.active .step-label {
      color: #034ea2;
      font-weight: 600;
    }

    /* Card */
    .card {
      background: white;
      border: 1px solid #e5e7eb;
      border-radius: 6px;
      margin-bottom: 16px;
    }

    .card-header {
      padding: 16px 20px;
      border-bottom: 1px solid #f3f4f6;
    }

    .card-title {
      font-size: 13px;
      font-weight: 600;
      color: #111827;
      margin-bottom: 4px;
    }

    .card-description {
      font-size: 12px;
      color: #6b7280;
      line-height: 1.5;
    }

    .card-body {
      padding: 20px;
    }

    /* Stats Grid */
    .stats-grid {
      display: grid;
      grid-template-columns: repeat(2, 1fr);
      gap: 12px;
      margin-bottom: 20px;
    }

    .stat-item {
      background: #f9fafb;
      border: 1px solid #e5e7eb;
      border-radius: 4px;
      padding: 12px;
      display: flex;
      align-items: center;
      gap: 12px;
    }

    .stat-icon {
      width: 36px;
      height: 36px;
      border-radius: 6px;
      background: linear-gradient(135deg, #034ea2 0%, #0260c4 100%);
      display: flex;
      align-items: center;
      justify-content: center;
      color: white;
      font-size: 16px;
      font-weight: 600;
    }

    .stat-content {
      flex: 1;
    }

    .stat-value {
      font-size: 18px;
      font-weight: 700;
      color: #111827;
      line-height: 1;
      margin-bottom: 4px;
    }

    .stat-label {
      font-size: 11px;
      color: #6b7280;
      font-weight: 500;
    }

    /* Buttons */
    .btn {
      display: inline-flex;
      align-items: center;
      justify-content: center;
      gap: 8px;
      padding: 0 16px;
      height: 36px;
      border: none;
      border-radius: 6px;
      font-size: 13px;
      font-weight: 500;
      cursor: pointer;
      transition: all 0.15s ease;
      width: 100%;
      font-family: inherit;
    }

    .btn-primary {
      background: #034ea2;
      color: white;
    }

    .btn-primary:hover:not(:disabled) {
      background: #023a7a;
    }

    .btn-primary:active:not(:disabled) {
      background: #022e61;
    }

    .btn-success {
      background: #10b981;
      color: white;
    }

    .btn-success:hover:not(:disabled) {
      background: #059669;
    }

    .btn-warning {
      background: #f59e0b;
      color: white;
    }

    .btn-warning:hover:not(:disabled) {
      background: #d97706;
    }

    .btn:disabled {
      opacity: 0.5;
      cursor: not-allowed;
    }

    .btn-icon {
      font-size: 14px;
    }

    /* Form Elements */
    .form-group {
      margin-bottom: 16px;
    }

    .form-label {
      display: block;
      font-size: 12px;
      font-weight: 500;
      color: #374151;
      margin-bottom: 6px;
    }

    .form-select {
      width: 100%;
      height: 36px;
      padding: 0 12px;
      border: 1px solid #d1d5db;
      border-radius: 6px;
      font-size: 13px;
      font-family: inherit;
      background: white;
      cursor: pointer;
    }

    .form-select:focus {
      outline: none;
      border-color: #034ea2;
      box-shadow: 0 0 0 3px rgba(3, 78, 162, 0.1);
    }

    /* File Upload */
    .file-upload {
      position: relative;
      margin-bottom: 16px;
    }

    .file-upload-input {
      display: none;
    }

    .file-upload-label {
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 8px;
      padding: 32px 20px;
      border: 2px dashed #d1d5db;
      border-radius: 6px;
      background: #fafbfc;
      color: #6b7280;
      font-size: 13px;
      cursor: pointer;
      transition: all 0.2s ease;
    }

    .file-upload-label:hover:not(.disabled) {
      border-color: #034ea2;
      background: #f0f7ff;
      color: #034ea2;
    }

    .file-upload-label.has-file {
      border-color: #10b981;
      background: #f0fdf4;
      color: #065f46;
      border-style: solid;
    }

    .file-upload-label.disabled {
      opacity: 0.5;
      cursor: not-allowed;
      background: #f3f4f6;
    }

    .file-info {
      margin-top: 8px;
      font-size: 11px;
      color: #6b7280;
      text-align: center;
    }

    .file-info.has-file {
      color: #065f46;
      font-weight: 500;
    }

    /* Alert */
    .alert {
      padding: 12px 16px;
      border-radius: 6px;
      font-size: 12px;
      line-height: 1.5;
      margin-bottom: 16px;
    }

    .alert-info {
      background: #eff6ff;
      border: 1px solid #bfdbfe;
      color: #1e40af;
    }

    .alert-success {
      background: #f0fdf4;
      border: 1px solid #bbf7d0;
      color: #166534;
    }

    .alert-warning {
      background: #fffbeb;
      border: 1px solid #fde68a;
      color: #92400e;
    }

    .alert-error {
      background: #fef2f2;
      border: 1px solid #fecaca;
      color: #991b1b;
    }

    .alert-title {
      font-weight: 600;
      margin-bottom: 4px;
    }

    /* Message List */
    .message-list {
      max-height: 120px;
      overflow-y: auto;
      margin-top: 8px;
      padding: 0;
      list-style: none;
    }

    .message-item {
      padding: 6px 0;
      font-size: 11px;
      border-bottom: 1px solid rgba(0, 0, 0, 0.05);
    }

    .message-item:last-child {
      border-bottom: none;
    }

    /* Loading Spinner */
    .spinner {
      border: 2px solid rgba(255, 255, 255, 0.3);
      border-top: 2px solid white;
      border-radius: 50%;
      width: 14px;
      height: 14px;
      animation: spin 0.6s linear infinite;
    }

    @keyframes spin {
      0% { transform: rotate(0deg); }
      100% { transform: rotate(360deg); }
    }

    /* Progress Bar */
    .progress-container {
      margin: 16px 0;
    }

    .progress-bar {
      width: 100%;
      height: 6px;
      background: #e5e7eb;
      border-radius: 3px;
      overflow: hidden;
    }

    .progress-fill {
      height: 100%;
      background: linear-gradient(90deg, #034ea2 0%, #0260c4 100%);
      transition: width 0.3s ease;
      border-radius: 3px;
    }

    .progress-text {
      font-size: 11px;
      color: #6b7280;
      margin-top: 6px;
      text-align: center;
    }

    /* Utility Classes */
    .hidden {
      display: none !important;
    }

    .mb-0 { margin-bottom: 0; }
    .mb-8 { margin-bottom: 8px; }
    .mb-12 { margin-bottom: 12px; }
    .mb-16 { margin-bottom: 16px; }
    .mb-20 { margin-bottom: 20px; }

    /* Scrollbar */
    ::-webkit-scrollbar {
      width: 6px;
      height: 6px;
    }

    ::-webkit-scrollbar-track {
      background: #f3f4f6;
    }

    ::-webkit-scrollbar-thumb {
      background: #d1d5db;
      border-radius: 3px;
    }

    ::-webkit-scrollbar-thumb:hover {
      background: #9ca3af;
    }

    /* Divider */
    .divider {
      height: 1px;
      background: #e5e7eb;
      margin: 20px 0;
    }

    .divider-text {
      text-align: center;
      position: relative;
      margin: 20px 0;
    }

    .divider-text::before {
      content: '';
      position: absolute;
      left: 0;
      top: 50%;
      width: 100%;
      height: 1px;
      background: #e5e7eb;
    }

    .divider-text span {
      position: relative;
      background: white;
      padding: 0 12px;
      font-size: 11px;
      color: #6b7280;
      text-transform: uppercase;
      letter-spacing: 0.05em;
      font-weight: 500;
    }
  </style>
</head>
<body>
  <!-- Header -->
  <div class="header">
    <div class="header-content">
      <div>
        <div class="header-title">Translation Manager</div>
        <div class="header-subtitle">Extract, translate, and apply text transformations</div>
      </div>
    </div>
  </div>

  <!-- Main Container -->
  <div class="container">
    
    <!-- Workflow Progress -->
    <div class="workflow">
      <div class="workflow-step active" id="workflow-step-1">
        <div class="step-circle">1</div>
        <div class="step-label">Extract</div>
      </div>
      <div class="workflow-step" id="workflow-step-2">
        <div class="step-circle">2</div>
        <div class="step-label">Export</div>
      </div>
      <div class="workflow-step" id="workflow-step-3">
        <div class="step-circle">3</div>
        <div class="step-label">Translate</div>
      </div>
      <div class="workflow-step" id="workflow-step-4">
        <div class="step-circle">4</div>
        <div class="step-label">Apply</div>
      </div>
    </div>

    <!-- Step 1: Extract -->
    <div class="card" id="extract-card">
      <div class="card-header">
        <div class="card-title">Extract Text Elements</div>
        <div class="card-description">Select a frame in your Figma document to extract all text layers with metadata</div>
      </div>
      <div class="card-body">
        <div class="alert alert-info mb-16">
          <div class="alert-title">Before you begin</div>
          Ensure you have selected the frame containing the text you want to translate.
        </div>
        <button class="btn btn-primary" id="extract-btn">
          <span class="btn-icon">â†“</span>
          <span>Extract Text from Selection</span>
        </button>
      </div>
    </div>

    <!-- Step 2: Export & Translation Options (Hidden) -->
    <div class="card hidden" id="export-card">
      <div class="card-header">
        <div class="card-title">Translation Options</div>
        <div class="card-description">Choose to download Excel template or use AI-powered translation</div>
      </div>
      <div class="card-body">
        <div class="stats-grid mb-20">
          <div class="stat-item">
            <div class="stat-icon" id="text-count-icon">0</div>
            <div class="stat-content">
              <div class="stat-value" id="text-count">0</div>
              <div class="stat-label">Text Elements</div>
            </div>
          </div>
          <div class="stat-item">
            <div class="stat-icon">âœ“</div>
            <div class="stat-content">
              <div class="stat-value">Ready</div>
              <div class="stat-label">Status</div>
            </div>
          </div>
        </div>
        
        <div class="alert alert-success mb-16">
          <div class="alert-title">Extraction Complete</div>
          Text elements captured with font styles, colors, sizes, and hyperlinks preserved.
        </div>

        <div class="divider-text">
          <span>Choose Translation Method</span>
        </div>

        <!-- Manual Excel Export -->
        <div class="mb-16">
          <button class="btn btn-success" id="export-btn">
            <span class="btn-icon">â¬‡</span>
            <span>Download Excel Template</span>
          </button>
        </div>

        <!-- AI Translation -->
        <div>
          <div class="form-group">
            <label class="form-label">AI Translation - Target Language</label>
            <select class="form-select" id="target-language">
              <option value="es">Spanish</option>
              <option value="fr">French</option>
              <option value="de">German</option>
              <option value="it">Italian</option>
              <option value="pt">Portuguese</option>
              <option value="ru">Russian</option>
              <option value="ja">Japanese</option>
              <option value="ko">Korean</option>
              <option value="zh">Chinese (Simplified)</option>
              <option value="ar">Arabic</option>
              <option value="hi">Hindi</option>
              <option value="nl">Dutch</option>
            </select>
          </div>

          <button class="btn btn-warning" id="translate-btn">
            <span class="btn-icon">âœ¨</span>
            <span>Translate with AI</span>
          </button>

          <!-- Translation Progress (Hidden) -->
          <div class="progress-container hidden" id="translation-progress">
            <div class="progress-bar">
              <div class="progress-fill" id="progress-fill" style="width: 0%"></div>
            </div>
            <div class="progress-text" id="progress-text">Translating 0 of 0...</div>
          </div>
        </div>
      </div>
    </div>

    <!-- Step 3: Upload & Apply (Hidden) -->
    <div class="card hidden" id="upload-card">
      <div class="card-header">
        <div class="card-title">Upload Translated File</div>
        <div class="card-description">Import your completed translation file to apply changes</div>
      </div>
      <div class="card-body">
        <div class="alert alert-info mb-16" id="upload-info">
          <div class="alert-title">Translation Guidelines</div>
          Fill the "Translation" column in the Excel file. Keep character count similar to avoid text overflow.
        </div>
        
        <div class="file-upload">
          <input type="file" id="file-input" class="file-upload-input" accept=".xlsx,.xls">
          <label for="file-input" class="file-upload-label" id="file-upload-label">
            <span class="btn-icon">ðŸ“Ž</span>
            <span>Choose translated Excel file</span>
          </label>
          <div class="file-info" id="file-info">No file selected</div>
        </div>

        <button class="btn btn-primary" id="apply-btn" disabled>
          <span class="btn-icon">âœ“</span>
          <span>Apply Translations</span>
        </button>
      </div>
    </div>

    <!-- Results (Hidden) -->
    <div class="card hidden" id="results-card">
      <div class="card-header">
        <div class="card-title">Application Results</div>
      </div>
      <div class="card-body">
        <div id="results-content"></div>
      </div>
    </div>

    <!-- Warnings (Hidden) -->
    <div class="card hidden" id="warnings-card">
      <div class="card-header">
        <div class="card-title">Warnings & Notices</div>
      </div>
      <div class="card-body">
        <div id="warnings-content"></div>
      </div>
    </div>

  </div>

  <!-- SheetJS Library -->
  <script src="https://cdn.sheetjs.com/xlsx-0.20.1/package/dist/xlsx.full.min.js"></script>

  <!-- Main Script -->
  <script>
    let extractedData = [];
    let uploadedFile = null;
    let translationMode = 'manual'; // 'manual' or 'ai'

    // UI Elements
    const extractBtn = document.getElementById('extract-btn');
    const exportBtn = document.getElementById('export-btn');
    const translateBtn = document.getElementById('translate-btn');
    const applyBtn = document.getElementById('apply-btn');
    const fileInput = document.getElementById('file-input');
    const fileUploadLabel = document.getElementById('file-upload-label');
    const fileInfo = document.getElementById('file-info');
    const textCount = document.getElementById('text-count');
    const textCountIcon = document.getElementById('text-count-icon');
    const targetLanguage = document.getElementById('target-language');
    const uploadInfo = document.getElementById('upload-info');
    
    const translationProgress = document.getElementById('translation-progress');
    const progressFill = document.getElementById('progress-fill');
    const progressText = document.getElementById('progress-text');
    
    const extractCard = document.getElementById('extract-card');
    const exportCard = document.getElementById('export-card');
    const uploadCard = document.getElementById('upload-card');
    const resultsCard = document.getElementById('results-card');
    const warningsCard = document.getElementById('warnings-card');
    
    const workflowStep1 = document.getElementById('workflow-step-1');
    const workflowStep2 = document.getElementById('workflow-step-2');
    const workflowStep3 = document.getElementById('workflow-step-3');
    const workflowStep4 = document.getElementById('workflow-step-4');

    // Update workflow
    function updateWorkflow(step) {
      [workflowStep1, workflowStep2, workflowStep3, workflowStep4].forEach((s, i) => {
        s.classList.remove('active', 'completed');
        if (i + 1 < step) s.classList.add('completed');
        if (i + 1 === step) s.classList.add('active');
      });
    }

    // Extract Text Button
    extractBtn.addEventListener('click', () => {
      extractBtn.disabled = true;
      extractBtn.innerHTML = '<div class="spinner"></div><span>Extracting...</span>';
      parent.postMessage({ pluginMessage: { type: 'extract-text' } }, '*');
    });

    // Export Excel Button
    exportBtn.addEventListener('click', () => {
      exportToExcel();
      translationMode = 'manual';
      uploadCard.classList.remove('hidden');
      fileInput.disabled = false;
      fileUploadLabel.classList.remove('disabled');
      updateWorkflow(3);
    });

    // Translate Button
    translateBtn.addEventListener('click', async () => {
      translationMode = 'ai';
      
      // Lock manual upload
      fileInput.disabled = true;
      fileUploadLabel.classList.add('disabled');
      uploadInfo.innerHTML = `
        <div class="alert-title">AI Translation Active</div>
        Manual file upload is disabled. AI translation is processing your texts.
      `;

      translateBtn.disabled = true;
      translateBtn.innerHTML = '<div class="spinner"></div><span>Translating...</span>';
      translationProgress.classList.remove('hidden');

      const language = targetLanguage.value;
      const languageNames = {
        'es': 'Spanish', 'fr': 'French', 'de': 'German', 'it': 'Italian',
        'pt': 'Portuguese', 'ru': 'Russian', 'ja': 'Japanese', 'ko': 'Korean',
        'zh': 'Chinese', 'ar': 'Arabic', 'hi': 'Hindi', 'nl': 'Dutch'
      };

      try {
        const translations = await translateTexts(
          extractedData.map(item => item.text),
          languageNames[language]
        );

        // Update extracted data with translations
        extractedData.forEach((item, index) => {
          item.translation = translations[index];
        });

        // Show success
        translationProgress.classList.add('hidden');
        translateBtn.disabled = false;
        translateBtn.innerHTML = '<span class="btn-icon">âœ“</span><span>Translation Complete</span>';
        translateBtn.classList.remove('btn-warning');
        translateBtn.classList.add('btn-success');

        // Prepare and send translations to Figma
        const translationData = extractedData.map(item => ({
          id: item.id,
          originalText: item.text,
          translation: item.translation,
          nodeId: item.nodeId,
          metadata: item
        }));

        updateWorkflow(4);
        uploadCard.classList.remove('hidden');
        
        // Show AI apply button
        resultsCard.classList.remove('hidden');
        document.getElementById('results-content').innerHTML = `
          <div class="alert alert-success mb-16">
            <div class="alert-title">AI Translation Complete</div>
            ${extractedData.length} text(s) translated to ${languageNames[language]}. Click below to apply to your Figma frame.
          </div>
          <button class="btn btn-primary" id="apply-ai-translations">
            <span class="btn-icon">âœ¨</span>
            <span>Apply AI Translations</span>
          </button>
        `;

        document.getElementById('apply-ai-translations').addEventListener('click', () => {
          document.getElementById('apply-ai-translations').disabled = true;
          document.getElementById('apply-ai-translations').innerHTML = '<div class="spinner"></div><span>Applying...</span>';
          
          parent.postMessage({ 
            pluginMessage: { 
              type: 'apply-translations', 
              data: translationData 
            } 
          }, '*');
        });

      } catch (error) {
        translationProgress.classList.add('hidden');
        translateBtn.disabled = false;
        translateBtn.innerHTML = '<span class="btn-icon">âœ¨</span><span>Translate with AI</span>';
        
        resultsCard.classList.remove('hidden');
        document.getElementById('results-content').innerHTML = `
          <div class="alert alert-error">
            <div class="alert-title">Translation Failed</div>
            ${error.message}
          </div>
        `;
      }
    });

    // Translate texts using DeepL
    async function translateTexts(texts, targetLang) {
      const allTranslations = [];
      
      // DeepL language codes mapping
      const deeplLanguageCodes = {
        'Spanish': 'ES',
        'French': 'FR',
        'German': 'DE',
        'Italian': 'IT',
        'Portuguese': 'PT-PT',
        'Russian': 'RU',
        'Japanese': 'JA',
        'Korean': 'KO',
        'Chinese': 'ZH',
        'Arabic': 'AR',
        'Hindi': 'HI',
        'Dutch': 'NL'
      };

      const targetLangCode = deeplLanguageCodes[targetLang] || 'ES';
      let processedCount = 0;

      // Process texts one by one
      for (let i = 0; i < texts.length; i++) {
        const text = texts[i];
        
        const formData = new URLSearchParams();
        formData.append('auth_key', DEEPL_API_KEY);
        formData.append('text', text);
        formData.append('target_lang', targetLangCode);

        const response = await fetch('https://api.deepl.com/v2/translate', {
          method: 'POST',
          headers: {
            'Content-Type': 'application/x-www-form-urlencoded',
          },
          body: formData
        });

        if (!response.ok) {
          const errorText = await response.text();
          throw new Error(`DeepL API error: ${errorText}`);
        }

        const data = await response.json();
        allTranslations.push(data.translations[0].text);

        processedCount++;
        const progress = (processedCount / texts.length) * 100;
        progressFill.style.width = `${progress}%`;
        progressText.textContent = `Translating ${processedCount} of ${texts.length}...`;
      }

      return allTranslations;
    }

    // File Input Change
    fileInput.addEventListener('change', (e) => {
      const file = e.target.files[0];
      if (file && !fileInput.disabled) {
        uploadedFile = file;
        fileUploadLabel.classList.add('has-file');
        fileUploadLabel.innerHTML = `<span class="btn-icon">âœ“</span><span>${file.name}</span>`;
        fileInfo.textContent = `${(file.size / 1024).toFixed(1)} KB â€¢ ${new Date().toLocaleString()}`;
        fileInfo.classList.add('has-file');
        applyBtn.disabled = false;
      }
    });

    // Apply Translations Button
    applyBtn.addEventListener('click', () => {
      if (uploadedFile) {
        readExcelFile(uploadedFile);
      }
    });

    // Helper function to get font info as string
    function getFontInfo(fontName) {
      if (fontName && fontName.family && fontName.style) {
        return `${fontName.family} ${fontName.style}`;
      }
      return 'Mixed';
    }

    // Helper function to get color as hex
    function getColorHex(fills) {
      if (!fills || fills === 'MIXED' || !Array.isArray(fills) || fills.length === 0) {
        return 'N/A';
      }
      const fill = fills[0];
      if (fill.type === 'SOLID') {
        const r = Math.round(fill.color.r * 255).toString(16).padStart(2, '0');
        const g = Math.round(fill.color.g * 255).toString(16).padStart(2, '0');
        const b = Math.round(fill.color.b * 255).toString(16).padStart(2, '0');
        return `#${r}${g}${b}`;
      }
      return 'N/A';
    }

    // Export to Excel
    function exportToExcel() {
      const data = extractedData.map(item => {
        // Clean text to prevent Excel formatting issues - each extraction in one cell
        const cleanText = (text) => {
          if (!text) return '';
          // Replace line breaks with spaces and trim
          return String(text).replace(/[\r\n]+/g, ' ').trim();
        };

        return {
          'Extraction_ID': item.id,
          'Extracted_Text': cleanText(item.text),
          'Translation': '',
          'Font_Family': getFontInfo(item.fontName),
          'Font_Size': item.fontSize !== 'MIXED' ? item.fontSize : 'Mixed',
          'Font_Weight': item.fontWeight !== 'MIXED' ? item.fontWeight : 'Mixed',
          'Text_Color': getColorHex(item.fills),
          'Character_Count': item.characterCount,
          'Width': Math.round(item.width),
          'Height': Math.round(item.height),
          'Text_Align_H': item.textAlignHorizontal,
          'Text_Align_V': item.textAlignVertical,
          'Auto_Resize': item.textAutoResize,
          'Has_Hyperlink': item.hasHyperlink ? 'Yes' : 'No',
          'Hyperlink_URLs': item.hasHyperlink && item.hyperlink.links.length > 0 
            ? item.hyperlink.links.map(l => l.url).join(', ') 
            : 'None'
        };
      });

      const ws = XLSX.utils.json_to_sheet(data);
      const wb = XLSX.utils.book_new();
      XLSX.utils.book_append_sheet(wb, ws, 'Translations');

      // Set column widths
      ws['!cols'] = [
        { wch: 15 },  // Extraction_ID
        { wch: 50 },  // Extracted_Text
        { wch: 50 },  // Translation
        { wch: 20 },  // Font_Family
        { wch: 12 },  // Font_Size
        { wch: 12 },  // Font_Weight
        { wch: 12 },  // Text_Color
        { wch: 15 },  // Character_Count
        { wch: 10 },  // Width
        { wch: 10 },  // Height
        { wch: 15 },  // Text_Align_H
        { wch: 15 },  // Text_Align_V
        { wch: 12 },  // Auto_Resize
        { wch: 15 },  // Has_Hyperlink
        { wch: 40 }   // Hyperlink_URLs
      ];

      // Ensure each cell is treated as text (prevents merging) - ONE EXTRACTION PER CELL
      const range = XLSX.utils.decode_range(ws['!ref']);
      for (let R = range.s.r; R <= range.e.r; ++R) {
        for (let C = range.s.c; C <= range.e.c; ++C) {
          const cellAddress = XLSX.utils.encode_cell({ r: R, c: C });
          if (!ws[cellAddress]) continue;
          
          // Force cells to be text type - ensures one extraction per cell
          if (ws[cellAddress].t !== 's') {
            ws[cellAddress].t = 's';
            ws[cellAddress].v = String(ws[cellAddress].v);
          }
        }
      }

      XLSX.writeFile(wb, 'figma_translations.xlsx');
    }

    // Read Excel File
    function readExcelFile(file) {
      applyBtn.disabled = true;
      applyBtn.innerHTML = '<div class="spinner"></div><span>Processing...</span>';
      updateWorkflow(4);

      const reader = new FileReader();
      reader.onload = (e) => {
        try {
          const data = new Uint8Array(e.target.result);
          const workbook = XLSX.read(data, { type: 'array' });
          const sheetName = workbook.SheetNames[0];
          const worksheet = workbook.Sheets[sheetName];
          const jsonData = XLSX.utils.sheet_to_json(worksheet);

          // Prepare translation data with metadata
          const translations = jsonData.map(row => {
            const originalItem = extractedData.find(item => item.id === row.Extraction_ID);
            if (!originalItem) {
              return null;
            }
            
            return {
              id: row.Extraction_ID,
              originalText: row.Extracted_Text,
              translation: row.Translation || row.Extracted_Text,
              nodeId: originalItem.nodeId,
              metadata: originalItem
            };
          }).filter(item => item !== null);

          // Send to Figma plugin
          parent.postMessage({ 
            pluginMessage: { 
              type: 'apply-translations', 
              data: translations 
            } 
          }, '*');

        } catch (error) {
          showError('Error reading Excel file: ' + error.message);
          applyBtn.disabled = false;
          applyBtn.innerHTML = '<span class="btn-icon">âœ“</span><span>Apply Translations</span>';
        }
      };
      reader.readAsArrayBuffer(file);
    }

    // Show Error
    function showError(message) {
      resultsCard.classList.remove('hidden');
      document.getElementById('results-content').innerHTML = `
        <div class="alert alert-error">
          <div class="alert-title">Error</div>
          ${message}
        </div>
      `;
    }

    // Handle Messages from Plugin
    window.onmessage = (event) => {
      const msg = event.data.pluginMessage;

      if (msg.type === 'text-extracted') {
        extractedData = msg.data;
        textCount.textContent = msg.count;
        textCountIcon.textContent = msg.count;
        
        // Show export card
        exportCard.classList.remove('hidden');
        
        // Update workflow
        updateWorkflow(2);
        
        // Reset extract button
        extractBtn.disabled = false;
        extractBtn.innerHTML = '<span class="btn-icon">â†“</span><span>Extract Text from Selection</span>';
      }

      if (msg.type === 'translation-applied') {
        applyBtn.disabled = false;
        applyBtn.innerHTML = '<span class="btn-icon">âœ“</span><span>Apply Translations</span>';
        
        // Re-enable AI translation button if it was used
        if (translationMode === 'ai') {
          translateBtn.disabled = false;
          translateBtn.innerHTML = '<span class="btn-icon">âœ¨</span><span>Translate with AI</span>';
          translateBtn.classList.remove('btn-success');
          translateBtn.classList.add('btn-warning');
        }
        
        resultsCard.classList.remove('hidden');
        
        // Show warnings if any
        if (msg.warnings && msg.warnings.length > 0) {
          warningsCard.classList.remove('hidden');
          let warningHtml = '<div class="alert alert-warning">';
          warningHtml += '<div class="alert-title">Text Overflow Warnings</div>';
          warningHtml += '<ul class="message-list">';
          msg.warnings.forEach(warning => {
            warningHtml += `<li class="message-item">${warning}</li>`;
          });
          warningHtml += '</ul></div>';
          document.getElementById('warnings-content').innerHTML = warningHtml;
        } else {
          warningsCard.classList.add('hidden');
        }
        
        if (msg.errorCount === 0) {
          document.getElementById('results-content').innerHTML = `
            <div class="alert alert-success">
              <div class="alert-title">Success</div>
              Applied ${msg.successCount} translation(s) successfully.
            </div>
          `;
        } else {
          let errorHtml = '<div class="alert alert-error">';
          errorHtml += `<div class="alert-title">Partial Success</div>`;
          errorHtml += `Applied ${msg.successCount} translation(s), but ${msg.errorCount} failed.`;
          
          if (msg.errors && msg.errors.length > 0) {
            errorHtml += '<ul class="message-list">';
            msg.errors.forEach(err => {
              errorHtml += `<li class="message-item">${err}</li>`;
            });
            errorHtml += '</ul>';
          }
          errorHtml += '</div>';
          document.getElementById('results-content').innerHTML = errorHtml;
        }
      }

      if (msg.type === 'error') {
        showError(msg.message);
        extractBtn.disabled = false;
        extractBtn.innerHTML = '<span class="btn-icon">â†“</span><span>Extract Text from Selection</span>';
      }
    };
  </script>
</body>
</html>